name: Check Lua Releases
on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:
jobs:
  check-release:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest Lua version
        id: get_version
        run: |
          # Lua官方FTP地址
          LUA_FTP="http://www.lua.org/ftp/"

          # 获取所有可用版本
          VERSIONS=$(curl -s $LUA_FTP | grep -o 'lua-[0-9]\+\.[0-9]\+\.[0-9]\+\.tar\.gz' | sed 's/lua-\(.*\)\.tar\.gz/\1/' | sort -Vr)

          # 取最新版本
          LATEST_VERSION=$(echo "$VERSIONS" | head -1)

          # 读取上次记录的版本
          if [ -f .lua-version ]; then
          CURRENT_VERSION=$(cat .lua-version)
          else
          CURRENT_VERSION=""
          fi

          echo "Latest version: $LATEST_VERSION"
          echo "Current version: $CURRENT_VERSION"

          # 如果版本不同，触发构建
          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ] && [ ! -z "$LATEST_VERSION" ]; then
          echo "New version detected: $LATEST_VERSION"
          echo "::set-output name=new_version::true"
          echo "::set-output name=version::$LATEST_VERSION"
          echo "$LATEST_VERSION" > .lua-version
          else
          echo "::set-output name=new_version::false"
          echo "No new version available"
          fi
